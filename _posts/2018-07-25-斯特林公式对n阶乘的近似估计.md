---
layout: post
title:  "斯特灵公式对n阶乘的近似"
categories: Math
permalink: /:title.html
---


## 定义

- <font color='darkblue'>**斯特灵公式（Stirling's approximation）**</font>：
  当n很大的时候，n阶乘的计算量十分大，因此用斯特灵公式对n阶乘进行近似计算，即使在n很小的时候，这个近似已经十分准确。
  <font color='red'>**注意**：斯特灵公式只是逼近真实结果，并不能划等。</font>
  其实这个公式是由亚伯拉罕·棣莫弗（Abraham de Moivre）首先提出的，其形式为：
  $$n!\simeq cn^{n+0.5} e^{-n}$$
  詹姆斯·斯特灵则证明了这个常数$$c=\sqrt{2\pi}$$, 其形式为：
  $$n!\simeq \sqrt{2\pi} \cdot \sqrt{n} \cdot (\frac{n}{e})^{n}=\sqrt{2\pi n} \cdot n^{n}e^{-n}$$
  或：
  $$\lim_{n\rightarrow \infty}{\frac{n!}{\sqrt{2\pi n} \cdot n^{n}e^{-n}}}=1 \Leftrightarrow \lim_{n\rightarrow \infty}{\frac{n!}{ n^{n+0.5}e^{-n}}}=\sqrt{2\pi}$$

> **注意**：$$\sqrt{2\pi}$$ 这个常数系数在等式中充当着修正系数的存在。详[@Desmos.com-修正前后对比图](https://www.desmos.com/calculator/xcnphxgpbc)。

在某些应用场合里，上式也可用积分代替，得到不含系数$$\sqrt{2\pi n}$$的形式，由$$ln(n!)=ln(1)+ln(2)+\cdots+ln(n)$$得：
$$ln(n!)=\sum_{1}^{n} ln(x)\approx\int_{1}^{n}{ln(x)dx}=nln(n)-n$$
由下图可见，当n很大时，可用上式对n阶乘进行近似，近似结果十分接近真实数值。。
![](https://upload.wikimedia.org/wikipedia/commons/thumb/e/e5/Stirling%27s_Approximation.svg/309px-Stirling%27s_Approximation.svg.png)

## 证明

- <font color='darkblue'>**利用泊松分布证明**</font>：
  因n非常大时，由中心极限定理，经连续性校正(continuity correction)后，泊松分布可近似用正态分布进行计算：
  $$P(r|\lambda)=e^{-\lambda}\frac{\lambda^{r}}{r!}\approx \frac{1}{\lambda \sqrt{2\pi}}e^{-\frac{(r-\lambda)^{2}}{2\lambda}}$$
  则当$$r=\lambda$$时，代入上式得：
  $$e^{-\lambda}\frac{\lambda^{\lambda}}{\lambda!}\approx \frac{1}{\sqrt{2\pi\lambda}}\Leftrightarrow \lambda!\approx\lambda^{\lambda}e^{-\lambda}\sqrt{2\pi\lambda}$$
  得证。  $$\blacksquare$$
  值得注意的是,若对上式两边各用自然对数来表示：
  $$lnx!\simeq xlnx-x+\frac{1}{2}ln2\pi x$$

> **注意**：可见，当需要较高精度的计算时，斯特灵公式可加上$$\frac{1}{2}ln2\pi x$$作为**精度修正项**。详：[@Desmos.com-修正前后精度对比](https://www.desmos.com/calculator/pgf1wjqar2)

## 实际应用

1. 对二项分布中的<font color='red'>**二项系数（binomial coefficient）**</font>进行近似:
   （注意：$$\simeq$$表示渐近等于 asymptotically equal)
   由$$\begin{pmatrix} N \\ r \end{pmatrix}=\frac { N! }{ (N-r)!r! }$$ 得：
   $$ln\begin{pmatrix} N \\ r \end{pmatrix}=ln\frac { N! }{ (N-r)!r! }=lnN!-ln(N-r)!-lnr!$$
   由斯特灵公式 $$lnx!\simeq xlnx-x$$ (*注意此处没有修正项*)
   $$(a).lnN!\approx NlnN-N$$
   $$(b).ln(N-r)!\approx (N-r)ln(N-r)-(N-r)$$
   $$(c).lnr!\approx rlnr-r$$
   将$$(a),(b),(c)$$代入得：
   $$ln\begin{pmatrix} N \\ r \end{pmatrix}\simeq NlnN-(N-r)ln(N-r)-rlnr \\
   =NlnN+(N-r)ln(\frac{1}{N-r})+rln(\frac{1}{r}) $$
   由
   $$(d).NlnN=-Nln\frac{1}{N}=-Nln(\frac{\frac{1}{N-r}}{\frac{N}{N-r}})=Nln(\frac{N}{N-r})-Nln(\frac{1}{N-r})$$
   $$(e).rln(\frac{1}{r})=rln(\frac{\frac{1}{N-r}}{\frac{r}{N-r}})=rln(\frac{1}{N-r})-rln(\frac{r}{N-r})$$
   将$$(d),(e)$$代入得：
   $$=Nln(\frac{N}{N-r})-Nln(\frac{1}{N-r})+(N-r)ln(\frac{1}{N-r})+rln(\frac{1}{N-r})-rln(\frac{r}{N-r}) \\
   =Nln(\frac{N}{N-r})-rln(\frac{r}{N-r}) $$
   再由$$rln(\frac{r}{N-r})$$变形：
   $$(f).rln(\frac{r}{N-r})=rln(\frac{\frac{N}{N-r}}{\frac{N}{r}})=rln(\frac{N}{N-r})-rln(\frac{N}{r})$$
   将$$(f)$$代入得：
   $$ln\begin{pmatrix} N \\ r \end{pmatrix}\simeq (N-r)ln(\frac{N}{N-r}) + rln(\frac{N}{r})$$
   由信息熵公式：
   $$H_{2}(x)=xlog_{2}\frac{1}{x}+(1-x)log_{2}\frac{1}{(1-x)}$$
   即有
   $$N\times H_{2}(\frac{r}{N})=N\times [\frac{r}{N}ln(\frac{N}{r})+\frac{N-r}{N}ln\frac{N}{N-r}]\\
   =(N-r)ln(\frac{N}{N-r}) + rln(\frac{N}{r})\\
   \simeq log_{2}\begin{pmatrix} N \\ r \end{pmatrix}$$
   则二项系数的近似为：
   $$\begin{pmatrix} N \\ r \end{pmatrix}\simeq 2^{NH_{2}(\frac{r}{N})}$$
   若需要进一步的修正使结果更为精确，则需加上修正项:
   $$log_{2}\begin{pmatrix} N \\ r \end{pmatrix}\simeq NH_{2}(\frac{r}{N})-0.5log_{2}[2\pi (1-\frac{r}{N})r]$$
   则二项系数的更为精确地近似为：
   $$\begin{pmatrix} N \\ r \end{pmatrix}\simeq 2^{NH_{2}(\frac{r}{N})-0.5log_{2}[2\pi (1-\frac{r}{N})r]}$$

> 对于上式右边$$0.5log_{2}[2\pi (1-\frac{r}{N})r]$$可视为变换为：
> $$0.5log_{2}[2\pi N\frac{N-r}{N}\frac{r}{N}]=0.5[log_{2}{2\pi }+log_{2}{r(N-r)}-log_{2}{N}]$$

详[@Desmos.com-修正前后图像对比](https://www.desmos.com/calculator/dvl9dqtymb)

1. 算法<font color='red'>**复杂度**</font>计算与分析
   由斯特灵公式：$$ln(N!)\simeq NlnN-N+0.5ln2\pi N$$,
   因此对于复杂度为$$N!$$的算法，可用上式近似
   因$$NlnN\gg 0.5ln2\pi N$$ 且$$NlnN=lnN^{N}$$
   $$O(N!)\simeq O(N^N)$$
2. 二项分布问题中，两<font color='red'>**对立事件发生次数恰好相等**</font>
   假设一枚标准普通的硬币，掷$$2n$$次恰有$$n$$次为正，$$n$$次为反，由二项分布表达式：
   $$\begin{pmatrix}2n \\ n\end{pmatrix}(\frac{1}{2})^{n}(\frac{1}{2})^{n}=\frac{(2n)!}{(n!)^2\cdot 2^{2n}}$$
   由斯特灵公式$$n!\simeq \sqrt{2\pi n} \cdot n^{n}e^{-n}$$，上式：
   $$\frac{(2n)!}{(n!)^2\cdot 2^{2n}} \simeq \frac {\sqrt{4\pi n} \cdot (\frac {2n}{e})^{n}}{2\pi \cdot (\frac {n}{e})^{2n}\cdot 2^{2n}}=\frac{1}{\sqrt{\pi n}}$$
   由上式得，当$$n=50$$时，正反次数恰好相等的可能性非常低，仅为$$0.08$$，且：
   $$\lim_{n\rightarrow \infty}{\frac{1}{\sqrt{\pi n}}}\rightarrow0$$
   由此可见随$$n$$的增大，这种特殊事件发生的概率几乎为0。
